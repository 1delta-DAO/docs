
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>Debt Swap · 1delta docs</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 6.0.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/honkit-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-add-js-css/63654e1b596cb2089644283fd05dd0e4-night.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-add-js-css/000a7422ccf1c8cc3f26daf362853295-footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-add-js-css/9126ee2b524e451535a83b807a1790d6-asciinema-player.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-add-js-css/84ba87115ca7c3c04df8ebdf4324a9e7-prism-okaidia.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-add-js-css/f1c68718168135cb2e5ce12a8fec8524-code.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-add-js-css/64284539b805db2b7a9f78be6e890e1c-sidebar.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-flexible-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-insert-logo/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/honkit-plugin-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/honkit-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/@honkit/honkit-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="migration.html" />
    
    
    <link rel="prev" href="collateral-swap.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../margin-aggregation.html">
            
                <a href="../../margin-aggregation.html">
            
                    
                    Margin Aggregation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../guide/overview.html">
            
                <a href="../../guide/overview.html">
            
                    
                    Guide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../guide/frontend.html">
            
                <a href="../../guide/frontend.html">
            
                    
                    Frontend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../../guide/programmatically.html">
            
                <a href="../../guide/programmatically.html">
            
                    
                    Programmatically
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../architecture/overview.html">
            
                <a href="../../architecture/overview.html">
            
                    
                    Architecture Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../../lenders/summary.html">
            
                <a href="../../lenders/summary.html">
            
                    
                    Lenders
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../../lenders/metrics.html">
            
                <a href="../../lenders/metrics.html">
            
                    
                    Metrics
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../contract-addresses/summary.html">
            
                <a href="../../contract-addresses/summary.html">
            
                    
                    Contract Addresses 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../summary.html">
            
                <a href="../summary.html">
            
                    
                    Contract API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../entrypoint.html">
            
                <a href="../entrypoint.html">
            
                    
                    Entrypoint
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../operations.html">
            
                <a href="../operations.html">
            
                    
                    Operations
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.1" data-path="../transfers.html">
            
                <a href="../transfers.html">
            
                    
                    Transfers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.2" data-path="../external-call.html">
            
                <a href="../external-call.html">
            
                    
                    External Call
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.2.1" data-path="../bridge/bridge.html">
            
                <a href="../bridge/bridge.html">
            
                    
                    Bridging
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.2.1.1" data-path="../bridge/stargate.html">
            
                <a href="../bridge/stargate.html">
            
                    
                    Stargate V2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.2.1.2" data-path="../bridge/across.html">
            
                <a href="../bridge/across.html">
            
                    
                    Across
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2.3" data-path="../lending.html">
            
                <a href="../lending.html">
            
                    
                    Lending
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.3.1" data-path="../lending/aave.html">
            
                <a href="../lending/aave.html">
            
                    
                    Aave
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.3.2" data-path="../lending/compound-v3.html">
            
                <a href="../lending/compound-v3.html">
            
                    
                    Compound V3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.3.3" data-path="../lending/compound-v2.html">
            
                <a href="../lending/compound-v2.html">
            
                    
                    Compound V2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.3.4" data-path="../lending/morpho.html">
            
                <a href="../lending/morpho.html">
            
                    
                    Morpho Blue
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2.4" data-path="../flash-loan.html">
            
                <a href="../flash-loan.html">
            
                    
                    Flash Loan
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.4.1" data-path="../flash-loan/standardized-interface.html">
            
                <a href="../flash-loan/standardized-interface.html">
            
                    
                    Standardized Interface
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.4.2" data-path="../flash-loan/singletons.html">
            
                <a href="../flash-loan/singletons.html">
            
                    
                    Singletons
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2.5" data-path="../margin.html">
            
                <a href="../margin.html">
            
                    
                    Margin
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.5.1" data-path="leverage.html">
            
                <a href="leverage.html">
            
                    
                    Leverage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.5.2" data-path="close.html">
            
                <a href="close.html">
            
                    
                    Close
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.5.3" data-path="collateral-swap.html">
            
                <a href="collateral-swap.html">
            
                    
                    Collateral Swap
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7.2.5.4" data-path="debt-swap.html">
            
                <a href="debt-swap.html">
            
                    
                    Debt Swap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.5.5" data-path="migration.html">
            
                <a href="migration.html">
            
                    
                    Migration
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Debt Swap</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <html><head></head><body><h1 id="debt-swap-borrow--repay">Debt Swap (Borrow &amp; Repay)</h1>
<p>This guide covers debt swaps, which allow users to change their debt composition without closing positions or affecting collateral balances.</p>
<h2 id="overview">Overview</h2>
<p>Debt swaps involve borrowing a new asset, swapping it for the currency needed to repay existing debt, then repaying the original debt. This maintains your leveraged position while switching between debt assets (e.g., from USDC debt to USDT debt).</p>
<p>The entire operation is wrapped in a flash loan to ensure atomicity and capital efficiency.</p>
<h2 id="example-scenario">Example Scenario</h2>
<p>We'll demonstrate switching debt on <strong>Aave V3</strong> from USDC to USDT while maintaining the same collateral position. The process involves:</p>
<ol>
<li>Flash loan USDT</li>
<li>Swap USDT to USDC via 1inch</li>
<li>Repay existing USDC debt</li>
<li>Borrow new USDT debt to repay flash loan</li>
<li>Refund any excess to user</li>
</ol>
<p><strong>Starting Position:</strong></p>
<ul>
<li>Collateral: 3 WETH</li>
<li>Debt: 8,000 USDC</li>
</ul>
<p><strong>Target:</strong></p>
<ul>
<li>Same collateral: 3 WETH</li>
<li>New debt: 8,000 USDT</li>
</ul>
<p>We'll use <strong>Morpho Blue</strong> as our flash loan provider for optimal rates.</p>
<hr></hr>
<h2 id="constants">Constants</h2>
<pre class="language-"><code class="lang-solidity"><span class="token comment">// The debt amount to swap</span>
<span class="token builtin">uint256</span> DEBT_AMOUNT <span class="token operator">=</span> <span class="token number">8000.0e6</span><span class="token punctuation">;</span>

<span class="token comment">// Default forwarder address</span>
<span class="token builtin">address</span> CALL_FORWARDER <span class="token operator">=</span> <span class="token number">0xfCa1154C643C32638AEe9a43eeE7f377f515c801</span><span class="token punctuation">;</span>

<span class="token comment">// 1Delta composer</span>
IComposer composer <span class="token operator">=</span> <span class="token function">IComposer</span><span class="token punctuation">(</span><span class="token number">0</span>x<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Aave V3 pool address</span>
<span class="token builtin">address</span> AAVE_V3_POOL <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span>x<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Aave V3 variable debt tokens</span>
<span class="token builtin">address</span> AAVE_V3_USDC_V_TOKEN <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span>x<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">address</span> AAVE_V3_USDT_V_TOKEN <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span>x<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1inch aggregation router</span>
<span class="token builtin">address</span> oneInchAggregationRouter <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0x111</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Morpho Blue flash loan source</span>
<span class="token builtin">address</span> MORPHO_BLUE <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0xbbb</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<hr></hr>
<h2 id="operation-sequence">Operation Sequence</h2>
<h3 id="integration-checklist">Integration Checklist</h3>
<ul>
<li>[ ] Debt delegation permissions configured</li>
<li>[ ] Protocol borrowing approvals set</li>
<li>[ ] Swap quotes validated for sufficient output</li>
<li>[ ] Health factor impact assessed</li>
<li>[ ] Slippage protection configured</li>
<li>[ ] Cross-protocol compatibility verified</li>
<li>[ ] Gas optimization strategies applied</li>
<li>[ ] Error handling and fallback mechanisms</li>
<li>[ ] Position rate tracking enabled</li>
</ul>
<h3 id="1-repay-existing-debt">1. Repay Existing Debt</h3>
<p>After receiving USDC from the swap, we repay the existing USDC debt. Setting amount to <code>0</code> repays up to the contract's balance or total debt, whichever is smaller.</p>
<p><strong>Important:</strong> Ensure all required approvals are granted beforehand (see Approvals section).</p>
<pre class="language-"><code class="lang-solidity"><span class="token builtin">bytes</span> <span class="token keyword">memory</span> repay <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>LENDING<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>LenderOps<span class="token punctuation">.</span>REPAY<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint16</span><span class="token punctuation">(</span>LenderIds<span class="token punctuation">.</span>UP_TO_AAVE_V3 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Aave V3 identifier</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>USDC<span class="token punctuation">)</span><span class="token punctuation">,</span>                        <span class="token comment">// Asset to repay</span>
    <span class="token builtin">uint128</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                          <span class="token comment">// 0 = repay up to balance/debt</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>                       <span class="token comment">// Debt owner</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                           <span class="token comment">// Variable rate mode</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>AAVE_V3_USDC_V_TOKEN<span class="token punctuation">)</span><span class="token punctuation">,</span>       <span class="token comment">// Variable debt token</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>AAVE_V3_POOL<span class="token punctuation">)</span>               <span class="token comment">// Aave V3 pool address</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Refund any excess USDC to user</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> transferToUser <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>TRANSFERS<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>TransferIds<span class="token punctuation">.</span>SWEEP<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>USDC<span class="token punctuation">)</span><span class="token punctuation">,</span>                       <span class="token comment">// Asset to transfer</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>                       <span class="token comment">// Recipient</span>
    <span class="token builtin">uint128</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                          <span class="token comment">// Send remaining balance</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Combine repay with refund</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> repayAndRefund <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    repay<span class="token punctuation">,</span>
    transferToUser
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="2-borrow-new-debt">2. Borrow New Debt</h3>
<p>We borrow exactly the flash loan amount (plus any fees) in USDT. The borrowed funds go directly to the forwarder to minimize transfers.</p>
<pre class="language-"><code class="lang-solidity"><span class="token builtin">bytes</span> <span class="token keyword">memory</span> borrow <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>LENDING<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>LenderOps<span class="token punctuation">.</span>BORROW<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint16</span><span class="token punctuation">(</span>LenderIds<span class="token punctuation">.</span>UP_TO_AAVE_V3 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Aave V3 identifier</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>USDT<span class="token punctuation">)</span><span class="token punctuation">,</span>                        <span class="token comment">// Asset to borrow</span>
    <span class="token builtin">uint128</span><span class="token punctuation">(</span>DEBT_AMOUNT<span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">// Flash loan repayment amount</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>CALL_FORWARDER<span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment">// Send directly to forwarder</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                           <span class="token comment">// Variable rate mode</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>AAVE_V3_POOL<span class="token punctuation">)</span>               <span class="token comment">// Aave V3 pool address</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="3-approvals">3. Approvals</h3>
<p>Required approvals for the operation to succeed:</p>
<pre class="language-"><code class="lang-solidity"><span class="token comment">// Approve Aave V3 pool to spend USDC for debt repayment</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> approvePool <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>TRANSFERS<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>TransferIds<span class="token punctuation">.</span>APPROVE<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>USDC<span class="token punctuation">)</span><span class="token punctuation">,</span>                       <span class="token comment">// Asset to approve</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>AAVE_V3_POOL<span class="token punctuation">)</span>               <span class="token comment">// Spender</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Approve Morpho Blue to pull USDT for flash loan repayment</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> approveMorpho <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>TRANSFERS<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>TransferIds<span class="token punctuation">.</span>APPROVE<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>USDT<span class="token punctuation">)</span><span class="token punctuation">,</span>                       <span class="token comment">// Asset to approve</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>MORPHO_BLUE<span class="token punctuation">)</span>                 <span class="token comment">// Spender</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-meta-swap-configuration">4. Meta Swap Configuration</h3>
<p>The swap operation converts borrowed USDT to USDC for debt repayment. Since funds are already at the forwarder from the borrow operation, we skip manual transfers.</p>
<pre class="language-"><code class="lang-solidity"><span class="token comment">// Configure the forwarder call to 1inch</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> callForwarderCall <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>EXT_CALL<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>oneInchAggregationRouter<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// Target contract</span>
    <span class="token builtin">uint128</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                          <span class="token comment">// No ETH value for ERC20 swap</span>
    <span class="token builtin">uint16</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token comment">// Call data length</span>
    data                                 <span class="token comment">// 1inch swap call data</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Approve 1inch to spend USDT</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> approve1inch <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>TRANSFERS<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>TransferIds<span class="token punctuation">.</span>APPROVE<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>USDT<span class="token punctuation">)</span><span class="token punctuation">,</span>                       <span class="token comment">// Asset to approve</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>oneInchAggregationRouter<span class="token punctuation">)</span>    <span class="token comment">// Spender</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Verify minimum output and transfer to composer</span>
<span class="token builtin">uint256</span> amountExpected <span class="token operator">=</span> <span class="token number">8000.0e6</span><span class="token punctuation">;</span> <span class="token comment">// Expected USDC amount</span>

<span class="token builtin">bytes</span> <span class="token keyword">memory</span> sweepAndCheckSlippage <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>TRANSFERS<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>TransferIds<span class="token punctuation">.</span>SWEEP<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>USDC<span class="token punctuation">)</span><span class="token punctuation">,</span>                       <span class="token comment">// Asset to sweep</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>composer<span class="token punctuation">)</span><span class="token punctuation">,</span>                   <span class="token comment">// Send to composer for repay</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>SweepType<span class="token punctuation">.</span>AMOUNT<span class="token punctuation">)</span><span class="token punctuation">,</span>
    amountExpected                       <span class="token comment">// Minimum required amount</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Combine forwarder operations</span>
callForwarderCall <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    approve1inch<span class="token punctuation">,</span>
    callForwarderCall<span class="token punctuation">,</span>
    sweepAndCheckSlippage
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create meta swap call through forwarder</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> metaSwap <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>EXT_CALL<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>CALL_FORWARDER<span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment">// Forwarder contract</span>
    <span class="token builtin">uint128</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                          <span class="token comment">// No ETH value</span>
    <span class="token builtin">uint16</span><span class="token punctuation">(</span>callForwarderCall<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// Call data length</span>
    callForwarderCall                    <span class="token comment">// Forwarder operations</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<hr></hr>
<h2 id="complete-operation-assembly">Complete Operation Assembly</h2>
<p>Putting it all together with the flash loan wrapper:</p>
<pre class="language-"><code class="lang-solidity"><span class="token builtin">uint128</span> flashLoanAmount <span class="token operator">=</span> <span class="token builtin">uint128</span><span class="token punctuation">(</span>DEBT_AMOUNT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Amount to flash loan</span>

<span class="token comment">// Inner operations executed within flash loan callback</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> innerOperation <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    borrow<span class="token punctuation">,</span>              <span class="token comment">// Borrow USDT and send to forwarder</span>
    metaSwap<span class="token punctuation">,</span>            <span class="token comment">// Swap USDT to USDC via forwarder</span>
    repayAndRefund       <span class="token comment">// Repay USDC debt and refund excess</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Flash loan wrapper</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> flashLoan <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>ComposerCommands<span class="token punctuation">.</span>FLASH_LOAN<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span>FlashLoanIds<span class="token punctuation">.</span>MORPHO_BLUE<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>USDT<span class="token punctuation">)</span><span class="token punctuation">,</span>                       <span class="token comment">// Flash loan asset</span>
    <span class="token builtin">address</span><span class="token punctuation">(</span>MORPHO_BLUE<span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">// Flash loan provider</span>
    flashLoanAmount<span class="token punctuation">,</span>                     <span class="token comment">// Flash loan amount</span>
    <span class="token builtin">uint16</span><span class="token punctuation">(</span>innerOperation<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// Callback data length</span>
    <span class="token builtin">uint8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                           <span class="token comment">// Morpho Blue pool ID</span>
    innerOperation                       <span class="token comment">// Operations to execute</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Complete operation sequence</span>
<span class="token builtin">bytes</span> <span class="token keyword">memory</span> composerOps <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
    approvePool<span class="token punctuation">,</span>      <span class="token comment">// Pre-approve Aave pool for USDC</span>
    approveMorpho<span class="token punctuation">,</span>    <span class="token comment">// Pre-approve Morpho Blue for USDT</span>
    flashLoan         <span class="token comment">// Execute flash loan with inner operations</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Execute the complete debt swap</span>
composer<span class="token punctuation">.</span><span class="token function">deltaCompose</span><span class="token punctuation">(</span>composerOps<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<hr></hr>
<h2 id="key-considerations">Key Considerations</h2>
<ol>
<li><p><strong>Debt Delegation:</strong> The operation requires prior debt delegation approval: <code>IDebtToken(AAVE_V3_USDT_V_TOKEN).approveDelegation(composer, type(uint256).max)</code></p>
</li>
<li><p><strong>Flash Loan Fees:</strong> The borrow amount must account for any flash loan fees to ensure complete repayment.</p>
</li>
<li><p><strong>Slippage Protection:</strong> The sweep operation with <code>SweepType.AMOUNT</code> ensures you receive sufficient USDC to repay the debt.</p>
</li>
<li><p><strong>Gas Optimization:</strong></p>
<ul>
<li>Approvals are placed outside the flash loan callback to reduce callback data size</li>
<li>Direct transfers to the forwarder eliminate unnecessary token movements</li>
<li>One-time approvals with maximum amounts reduce future gas costs</li>
</ul>
</li>
<li><p><strong>Atomic Execution:</strong> The entire operation succeeds or fails as one transaction, preventing partial execution risks.</p>
</li>
<li><p><strong>Excess Handling:</strong> Any excess USDC from the swap is automatically refunded to the user, ensuring no funds are stuck.</p>
</li>
</ol>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="general.md">General Margin Operations</a> - Architecture overview</li>
<li><a href="../flash-loan.html">Flash Loan Operations</a> - Provider details</li>
<li><a href="../external-call.html">External Call Patterns</a> - Swap integration</li>
<li><a href="../lending.html">Lending Operations</a> - Protocol interactions</li>
</ul>
</body></html>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="collateral-swap.html" class="navigation navigation-prev " aria-label="Previous page: Collateral Swap">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="migration.html" class="navigation navigation-next " aria-label="Next page: Migration">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Debt Swap","level":"1.7.2.5.4","depth":4,"next":{"title":"Migration","level":"1.7.2.5.5","depth":4,"path":"api/margin/migration.md","ref":"./api/margin/migration.md","articles":[]},"previous":{"title":"Collateral Swap","level":"1.7.2.5.3","depth":4,"path":"api/margin/collateral-swap.md","ref":"./api/margin/collateral-swap.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-highlight","honkit-plugin-prism","add-js-css","edit-link","flexible-alerts","insert-logo","pagefooter","-lunr","-search","search-plus"],"root":".","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"honkit-plugin-prism":{"theme":"solarized-dark"},"pagefooter":{"footer":"<div>© 1delta <a href='https://1delta.io/'>https://1delta.io/</a></br>Found an error in the docs? The source code can be found <a href='https://github.com/1delta-DAO/docs/blob/main/README.md'>here</a>. Please feel free to edit and contribute a merge request<div>","label":"Modified at: ","format":"YYYY-MM-DD HH:mm:ss","utc":true},"add-js-css":{"js":["./scripts/asciinema-player.js","./scripts/code-header.js","./scripts/sidebar.js"],"css":["./style/night.css","./style/footer.css","./style/asciinema-player.css","./style/prism-okaidia.css","./style/code.css","./style/sidebar.css"]},"fontsettings":{"theme":"night","family":"sans","size":2},"flexible-alerts":{"style":"callout","note":{"label":"Note","icon":"fa fa-info-circle","className":"info"},"tip":{"label":"Tip","icon":"fa fa-lightbulb-o","className":"tip"},"warning":{"label":"Warning","icon":"fa fa-exclamation-triangle","className":"warning"},"danger":{"label":"Attention","icon":"fa fa-ban","className":"danger"}},"edit-link":{"label":"Edit on GitHub","base":"https://github.com/1delta-DAO/docs/blob/main"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"insert-logo":{"url":"https://raw.githubusercontent.com/1delta-DAO/protocol-icons/main/1delta_logo.svg","style":"background: #0f1823; width: 100%; padding: 20px; margin: 0px; border-radius: 15px;"},"search-plus":{}},"theme":"default","honkit":">=3.0.0","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"esversion":"2019","nodeversion":"12.13.0","npmversion":"6.12.0","triplebackticks":"```","console":"<a class=\"gitbook-plugin-js-console\" aria-hidden=\"true\"></a>"},"title":"1delta docs","gitbook":">=3.0.0"},"file":{"path":"api/margin/debt-swap.md","mtime":"2025-09-04T13:50:18.076Z","type":"markdown"},"gitbook":{"version":"6.0.3","time":"2025-09-04T13:51:16.791Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-add-js-css/e5f66c57646e52f3a8966ea585b6a700-asciinema-player.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-add-js-css/6be327ed75c531de33a4cffa46e679f8-code-header.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-add-js-css/0b7d652afee1550d372bc2b9a01ca14f-sidebar.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-flexible-alerts/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-insert-logo/plugin.js"></script>
        
    
        
        <script src="../../gitbook/honkit-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/honkit-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../../gitbook/@honkit/honkit-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

